--- 
title: "5702 Final Project Group 19"
author: "Jingqi Huang, Shaonan Wang, Baochan Jiang"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

In this project, We want to study the safe issue in the New York City. It is always heard that New York City is dangerous for living with a high crime rate. As students new to the city, we want to find out if the rumor is true or not. We also would like to understand the detailed crime situations and distributions in the city, such as where would be the safest areas in NYC, when the crimes usually happen, and what kind of crimes happen more frequently. These information can help people newly coming to NYC to have a better sense of the city's safe status and choose safe areas to live and socialize in order to better protect themselves. For this purpose, we are going to use NYPD Complaint Data Historic in recent years for the analysis.

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Proposal

## Research topic
Our project focuses on researching the safety situation in the New York City. We aim to answer questions like "Is it safe to live in New York City? Where are the safest regions to live in terms of low violence?". In the metropolitan areas, the safety concern is shown as the occurrence of the crime. The time and location of the crime occurrence, types of crimes conducted, information about criminals and suspects, crime occurrence frequency are possible factors we care about. 

## Data availability
NYPD Complaint Data Historic data is available on the NYC OpenData website (https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i). and narrow down the date range to most  recent 3 years that the dataset includes (2017/01/01-2020/01/01).

<!--chapter:end:proposal.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data 

## Sources
https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i

Weâ€™d like to find integrated data sets from the official website for research. Such data is more comprehensive and accurate, and it is also conducive to our data processing and analysis. Thus we choose NYC OpenData as our data sources. We tried to find data related to violence in New York City, so we decided to use complaint data of crime in NYC. The data is provided and maintained by the New York Police Department (NYPD), owned by NYC OpenData. This data is manually extracted every quarter and reviewed by the NYPD. Each record represents a criminal complaint in NYC and includes information about the type of crime, the location and time of enforcement. It can be directly downloaded from the NYC OpenData website in the CSV format, so we can simply import the CSV file. The dataset contains valid felony, misdemeanor, and violation crimes reported to the NYPD from 2006 to the end of 2019. If we have any questions about the data, we can send a note to NYC OpenData (NYC Open Data - Contact Us (https://opendata.cityofnewyork.us/engage/)). 

Known issues relating to data quality:
The dataset contains some null values, because the data was not collected or not available at the time of report. This may lead to bias in our study of the distribution of the data.
The dataset is released based on the date the incident was reported, but some crimes may have occurred years before they were reported. 
Some crimes that were not able to be geo-coded have been located as occurring at the police station house within the precinct of occurrence. This will cause a certain bias in the geographical analysis, but this bias can be avoided by appropriately expanding the geographical scope when grouping.

## Cleaning / transformation

We directly downloaded the data from the website and saved in a CSV file. When downloading, we filtered out the date range we are interested in - from 2017/01/01 to 2020/01/01. Most of the features in the dataset are in text format, and numeric values are in correct scales and format, so the data transformation is not necessary. There are several features where most of the information is not recorded, like name of NYC park, playground or greenspace of occurrence, name of NYCHA housing development of occurrence, and transit district in which the offense occurred, so we would not include them in our analysis. Also, there are pairs of features showing the same information, such as offense classification code & code description, internal offense class code & code description, jurisdiction code & code description. As the code itself would not tell much information about the features, we removed these codes and only kept the corresponding short description the code refers to.

```{r}
#package loading
library(dplyr)
library(tidyr)
library(tidyverse)
library(redav)
```


```{r}
df_clean <- df %>% select(-c(JURIS_DESC, JURISDICTION_CODE, PARKS_NM, HADEVELOPT, HOUSING_PSA, TRANSIT_DISTRICT, STATION_NAME, ADDR_PCT_CD, KY_CD, PD_CD))
#head(df,5)
```



## Missing value analysis

We performed analysis on missing values to see if there are any patterns of the missing data. 

We first wanted to know the amount of missing data in each feature and which feature(s) contain insufficient data to perform the analysis with. From the distribution of missing data of each feature, we can see that "TRANSIT_DISTRICT" (transit district in which the offense occurred) and "HOUSING_PSA" (development level code) have about 97% and 30% of missing rows separately, which are the top two features with missing values among 35 features. There are also other features with rows missing values, such as "PD_CD" (internal classification code) and "JURISDICTION_CODE", but the percentages are below 1%, which are not explicitly displayed in the plot.

```{r}
data=read.csv("~/NYPD_Complaint_Data_Historic.csv")
df<-as.data.frame(data)
#df %>% summarise_all(funs(n_distinct(.)))
col_missing <- colSums(is.na(df)) %>% sort(decreasing = TRUE)
col_missing = (col_missing/nrow(df))*100
```

```{r}
col_missing
```


```{r}
tidy_missing = 
    as.data.frame(col_missing) %>% 
    rownames_to_column("id") %>% 
    gather(key, value, -id) 
tidy_missing$id <- as.factor(tidy_missing$id)

ggplot(tidy_missing, aes(x=fct_rev(fct_reorder(id,value,.desc = FALSE)),y=value)) +
geom_bar(stat='identity',fill = "cornflowerblue") +
#scale_x_discrete(breaks = levels(tidy_missing$id)[c(T,T, rep(F, 33))]) +
scale_x_discrete(guide = guide_axis(n.dodge=6))+
xlab("") + 
ylab("Percentage of Missing Rows")
    
```


```{r}
# tidydf <- df %>% 
#     rownames_to_column("id") %>% 
#     gather(key, value, -id) %>%
#     mutate(missing = ifelse(is.na(value), "yes", "no"))
# 
# ggplot(tidydf, aes(x = key, y = fct_rev(id), fill = missing)) +
#   geom_tile(color = "white") + 
#   ggtitle("mtcars with NAs added") +
#   ylab('') + 
#   scale_fill_viridis_d() + # discrete scale
#   theme_bw()
```

In addition to the percentage of missing values in each feature, we can also show the missing patterns. There are 8 missing patterns in the dataset, where about 65% of rows belong to the first pattern and over 25% of rows in the second pattern. Therefore, there are lots of rows missing data in several features, as it's impossible to fill these values as they are categorial features with text data, so we decided to remove them in the analysis.


```{r}
#colnames(df) <- seq(1,length(colnames(df)))
#data_cleaned = as.list(df)
plot_missing(df, percent = TRUE)
```



<!--chapter:end:data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

Here, we analyze each variable one by one to see how the crime rate changes under different categories.


```{r}
#data=read.csv("D:/Desktop/GR5702/Final/NYPD_Complaint_Data_Historic.csv")
#data=read.csv("~/Desktop/NYPD_Complaint_Data_Historic.csv")
#data=read.csv("~/NYPD_Complaint_Data_Historic.csv")
```

```{r}
# package
library(ggalluvial)
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(vcd)
library(grid)
library(parcoords)
library(plotly)
library(dplyr)
```

## Variables

### RPT_DT

Variable "RPT_DT" is the date that the event was reported to police.

From the Time Series plot, we found that the year-to-year crime trends were similar, with lower numbers at the beginning and end of the year and higher numbers in the middle of the year. 

```{r}
t6<-as.data.frame(table(data$RPT_DT))
t6$Var1<-as.Date(t6$Var1,"%m/%d/%Y")
ggplot(t6, aes(x=Var1, y=Freq)) +
  geom_line()
```

Therefore, we break down the number of crimes by month. Crimes are higher from May to October and highest in July, lowest in February.

```{r}
data$month<-str_sub(data$RPT_DT,1,2)
barplot(table(data$month))
```

### OFNS_DESC

Variable "OFNS_DESC" is the crime description of corresponding to the offense event. 

As we can see from the Cleveland dot plot below, in the New York area, the most committed crime was "Petit Larceny". Appeared more than 200,000 times from 2017 to 2019. Besides, the crimes of harrassment also exceed 200,000 times and crimes of assault & related offenses, criminal mischief, grand larceny exceed 100,000 times. These were the types of crimes that occurred the most during the three-year period. They are sudden crimes and mainly threaten personal financial security.

```{r}
data$year<-str_sub(data$RPT_DT,7,10)
a<-as.data.frame(table(data$OFNS_DESC,data$year))
colnames(a)<-c("offense","year","Freq")
temp<-subset(a,a$Freq>100)

ggplot(temp,aes(x=Freq,y=fct_reorder2(offense,year=="2019",Freq,.desc=FALSE)))+
  geom_point(aes(color=year))+
  ggtitle("crimes in offense category") +
  xlab("counts") +
  ylab("")
```

### LAW_CAT_CD, BORO_NM

Variable "LAW_CAT_CD" is the level of offense, it contains felony, misdemeanor and violation. Variable "BORO_NM" is the name of the borough in which the incident occurred.

As we can see from the Horizontal Stacked Bar chart, Brooklyn has the most crimes and Staten Island has the least. This may be caused by the population gap, but still reminds us of the security situation in different regions. At the same time, from the perspective of crime level, most crimes are misdemeanors, and the number of serious crimes is second. But in terms of seriousness, felony causes greater personal harm and social impact, so we need to pay more attention to its data. In terms of numbers, the Brooklyn area had the highest number of felony crimes. But in terms of proportion, the proportion of felony crimes in each region is near 20%. 


```{r}
t1<-as.data.frame(table(data$BORO_NM,data$LAW_CAT_CD))
t1<-t1[t1$Var1!="",]
ggplot(t1, aes(x = Freq ,y=reorder(Var1,Freq),fill=Var2)) + 
  geom_bar(stat='identity')+
  ylab("crime counts")+
  xlab("Borough")
```

### PREM_TYP_DESC

Variable "PREM_TYP_DESC" is specific description of where the crime occurred, e.g. grocery store, home, street, etc.

The most crimes occurred on the street, followed by residential apartment house, with more than 100,000 crimes during three years. Crimes occurred in each year is similar, there is no sudden decrease or sudden increase.


```{r}
data$year<-str_sub(data$RPT_DT,7,10)
b<-table(data$PREM_TYP_DESC,data$year)
c<-as.data.frame.array(b)
c<-data.frame(premise=row.names(b),c)

colnames(c)<-c("premise","2017","2018","2019")
c$total<-c$`2017`+c$`2018`+c$`2019`

d<-subset(c,c$total>5000)
data.frame(d)  %>%
  parcoords(  
    rownames = F   
    , brushMode = "1D-axes"  
    , reorderable = T
    , queue = T  
    , color = list(  
      colorBy = "premise"  
      ,colorScale = "scaleOrdinal"  
      ,colorScheme = "schemeCategory10"  
    )  
    , withD3 = TRUE  
  )
```

### Latitude and Longitude
This part contains two variables "Latitude" and "Longitude".

As we can see from the histogram of crime frequency count corresponding to latitude and longitude, there are multi peaks in both graphs. This might indicate that there are some regions with more crimes happened. For example, there is a peak around 40.755 on latitude and a peak around -73.99 on longitude. Locating (40.755, -73.99) is somewhere near time square. The data might suggest that there are more crime happend near around this region.
```{r}
p1 <- ggplot(data, aes(x=Latitude))+
  geom_histogram(binwidth=0.005)
p2 <- ggplot(data, aes(x=Longitude))+
  geom_histogram(binwidth=0.005)
ggplotly(p1)
ggplotly(p2)
```

From the scatter plot and 2D histogram, we can see that Manhattan and Bronx has densest crime happened, then is Brooklyn, Queens, and  last Staten Island. The crimes happened in central park is rare according to both graphs, suggesting that it might be a safe place on Manhattan. The 2d histogram again confirm our previous guess that there are many crimes happened near time square. 

```{r}
ggplot(data, aes(x=Longitude, y=Latitude, color=BORO_NM))+
  geom_point(size=0.005, alpha=0.0075)
```

```{r}
ggplot(data, aes(x=Longitude, y=Latitude))+
  geom_bin2d(binwidth=c(0.005, 0.005))+
  scale_fill_distiller(palette="YlOrRd", direction=1)
```

### Age_group

This part contains two variables "SUSP_AGE_GROUP" and "VIC_AGE_GROUP". These records the ages of suspects and victims of offense, helping us better understand the characteristics of suspects and helping us identify potential threats.

Ignoring the group of unknown, we see that both suspects and victims are concentrated between 25-44 years old. The numbers of both suspects and victims gradually decrease as age decreases before 25 years old or increases after 44 years old.

```{r}
data1<-data[,c(24:26,33:35)]
data1$SUSP_AGE_GROUP[data1$SUSP_AGE_GROUP==""]<- NA #why set empty to NA. Is there differen between "" and unknown?
data1$SUSP_RACE[data1$SUSP_RACE==""]<- NA
data1$SUSP_SEX[data1$SUSP_SEX==""]<- NA

data1$VIC_AGE_GROUP[data1$VIC_AGE_GROUP==""]<- NA
data1$VIC_RACE[data1$VIC_RACE==""]<- NA
data1$VIC_SEX[data1$VIC_SEX==""]<- NA

data1$SUSP_AGE_GROUP<-ifelse(data1$SUSP_AGE_GROUP=="<18","<18",
                             ifelse(data1$SUSP_AGE_GROUP=="18-24","18-24",
                                    ifelse(data1$SUSP_AGE_GROUP=="25-44","25-44",
                                           ifelse(data1$SUSP_AGE_GROUP=="45-64","45-64",
                                                  ifelse(data1$SUSP_AGE_GROUP=="65+","65+","Unknown")))
))


data1$VIC_AGE_GROUP<-ifelse(data1$VIC_AGE_GROUP=="<18","<18",
                             ifelse(data1$VIC_AGE_GROUP=="18-24","18-24",
                                    ifelse(data1$VIC_AGE_GROUP=="25-44","25-44",
                                           ifelse(data1$VIC_AGE_GROUP=="45-64","45-64",
                                                  ifelse(data1$VIC_AGE_GROUP=="65+","65+","Unknown")))
                             ))
```

```{r}
t2<-as.data.frame(table(data1$SUSP_AGE_GROUP))
t3<-as.data.frame(table(data1$VIC_AGE_GROUP))
t2_t3<-merge(t2,t3,by="Var1")
colnames(t2_t3)<-c("age","susp",'vic')
tidyt<-t2_t3%>%pivot_longer(cols=!age,names_to = "type",values_to = "count")
ggplot(tidyt, aes(x = age, y = count)) +
  geom_bar(
    aes(color = type, fill = type),
    stat = "identity", position = position_dodge(0.8),
    width = 0.7
  )+
  facet_wrap(~type)
```

```{r}
data1_age_freq <- data1 %>% group_by(SUSP_AGE_GROUP, VIC_AGE_GROUP) %>% summarize(Freq = n())%>% ungroup() %>% filter(!is.na(SUSP_AGE_GROUP) && !is.na(VIC_AGE_GROUP)) %>% filter(SUSP_AGE_GROUP!="Unknown") %>% filter(VIC_AGE_GROUP!="Unknown")
```

From the alluvial graph, we see that crimes more likely to happen between peers from same age group. The percentage of crime decreases as age difference enlarges. One thing we notice is that for suspects aging below 18, the percentage of victim aging between 18 and 24 is less than 25-44 age range and even less than 45-64 age range.

```{r}
ggplot(data1_age_freq, aes(axis1=SUSP_AGE_GROUP, axis2=VIC_AGE_GROUP, y=Freq))+
  geom_flow(aes(fill=SUSP_AGE_GROUP))+
  geom_stratum()+
  geom_text(stat="stratum", aes(label=paste(after_stat(stratum), "\n", after_stat(count))), size=2)+
  scale_x_discrete(limits=c("susp_age_group", "vic_age_group"))
```

### Race

This part also contains two variables "SUSP_RACE" and "VIC_RACE". These records the race of suspects and victims of offense.

Sorted by suspect's race, ignoring UNKNOWN group, We found that the race with the more suspects, the more victims. Blacks have the most suspects and victims, which reminds us that the living environment of blacks in New York may be worse than other races.


```{r}
t4<-as.data.frame(table(data1$SUSP_RACE))
t5<-as.data.frame(table(data1$VIC_RACE))
t4_t5<-merge(t4,t5,by="Var1")
colnames(t4_t5)<-c("race","susp",'vic')
tidyt<-t4_t5%>%pivot_longer(cols=!race,names_to = "type",values_to = "count")

library(forcats)
ggplot(tidyt,aes(x=count,y=fct_reorder2(race,type=="susp",count,.desc=FALSE)))+
  geom_point(aes(color=type),size=3)
```

From the alluvial graph, we see that crimes more likely to happen between peers from same race. From both graphs, we see that blacks and black hispanic has more suspects than victims. For victims from almost all races, the largest proportion of corresponding suspect comes from same race, the second largest proportion of corresponding suspect comes from Blacks(except for AMERICAN INDIAN/ALASKAN NATIVE where the race of most suspect is Black and second largest is same, and Black where the second largest is White Hispanic). 
```{r}
data1_race_freq <- data1 %>% group_by(SUSP_RACE, VIC_RACE) %>% summarize(Freq = n())%>% ungroup()%>% filter(!is.na(SUSP_RACE) && !is.na(VIC_RACE)) %>% filter(SUSP_RACE!="UNKNOWN") %>% filter(VIC_RACE!="UNKNOWN")
```
```{r}
ggplot(data1_race_freq, aes(axis1=SUSP_RACE, axis2=VIC_RACE, y=Freq))+
  geom_flow(aes(fill=VIC_RACE))+
  geom_stratum()+
  geom_text(stat="stratum", aes(label=paste(after_stat(stratum), "\n", after_stat(count))), size=2)+
  scale_x_discrete(limits=c("susp_race", "vic_race"))
```

## Relationships

### SUSP_SEX & law_cat_cd

This mosaic plot showed us the relationship between suspect's sex and the level of offenses. Among all crimes, male suspects accounted for the highest proportion. Female suspects take a relatively large proportion of the level of violation, and the proportion of female suspects gradually decreasing as the severity of the offenses increases.

```{r}
data1$law_cat_cd=data$LAW_CAT_CD
mosaic(SUSP_SEX~law_cat_cd,data1,direction = c("v", "h"))

data1$law_cat_cd=data$LAW_CAT_CD
mosaic(VIC_SEX~law_cat_cd,data1,direction = c("v", "h"))
```

```{r}
data1_sex_freq <- data1 %>% group_by(SUSP_SEX, VIC_SEX) %>% summarize(Freq = n())%>% ungroup()%>% filter(!is.na(SUSP_SEX) && !is.na(VIC_SEX)) %>% filter(SUSP_SEX!="UNKNOWN") %>% filter(VIC_SEX!="UNKNOWN")
ggplot(data1_sex_freq, aes(axis1=SUSP_SEX, axis2=VIC_SEX, y=Freq))+
  geom_flow(aes(fill=VIC_SEX))+
  geom_stratum()+
  geom_text(stat="stratum", aes(label=paste(after_stat(stratum), "\n", after_stat(count))), size=2)+
  scale_x_discrete(limits=c("susp_sex", "vic_sex"))
```

From the mosaic plot and alluvial plot, we can see that female victims involve in a crime having a male suspect, and male suspect choose female victim as top target.



<!--chapter:end:results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:conclusion.Rmd-->

